<!DOCTYPE html>
<html>
<head>
<title>Messenger Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body { margin:0; background:#ece5dd; }
.sidebar { height:100vh; background:white; border-right:1px solid #ddd; overflow-y:auto; }
.chat-item { padding:12px 15px; cursor:pointer; border-bottom:1px solid #f1f1f1; }
.chat-item:hover { background:#f5f5f5; }
.chat-window { height:100vh; display:flex; flex-direction:column; }
.chat-header { padding:15px; background:#198754; color:white; display:flex; justify-content:space-between; align-items:center; }
.chat-body { flex:1; padding:20px; overflow-y:auto; background:#ece5dd; }
.chat-footer { padding:10px; background:white; }
.msg-sent { background:#dcf8c6; padding:10px; border-radius:15px; margin-bottom:10px; max-width:60%; margin-left:auto; }
.msg-received { background:white; padding:10px; border-radius:15px; margin-bottom:10px; max-width:60%; }
</style>
</head>

<body>

<div class="container-fluid">
<div class="row">

<!-- SIDEBAR -->
<div class="col-md-4 sidebar p-0">

<div class="p-3 bg-success text-white">
<div class="d-flex justify-content-between align-items-center mb-2">
<strong>My Chats</strong>
<div>
<button onclick="createGroup()" class="btn btn-light btn-sm me-2">+ Group</button>
<button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
</div>
</div>

<input type="text"
id="userSearch"
class="form-control form-control-sm"
placeholder="Search users..."
onkeyup="searchUsers()">
</div>

<div id="searchResults"></div>
<div id="chatList"></div>
</div>

<!-- CHAT AREA -->
<div class="col-md-8 p-0">
<div class="chat-window">

<div class="chat-header" id="chatHeader">
Select a chat
</div>

<div class="chat-body" id="chatBody"></div>

<div class="chat-footer">
<div class="input-group">
<input type="text" id="messageInput" class="form-control">
<button onclick="sendMessage()" class="btn btn-success">Send</button>
</div>
</div>

</div>
</div>

</div>
</div>

<!-- MEMBERS MODAL -->
<div class="modal fade" id="membersModal">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header bg-success text-white">
<h5 class="modal-title">Group Members</h5>
<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">

<div id="memberList"></div>

<hr>

<div id="adminSection" style="display:none;">
<input type="text" id="groupSearch" class="form-control mb-2"
placeholder="Search users to add..."
onkeyup="searchGroupUsers()">
<div id="groupSearchResults"></div>
</div>

</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const BASE="http://127.0.0.1:8000";
const token=localStorage.getItem("access_token");
if(!token) window.location.replace("/");

function parseJwt(token){ return JSON.parse(atob(token.split('.')[1])); }
const myId=parseJwt(token).user_id;

let currentChat=null;
let currentType=null;

//////////////////////////////////////////////////
// LOGOUT
//////////////////////////////////////////////////

function logout(){
Swal.fire({
title: "Logout?",
text: "Are you sure you want to logout?",
icon: "warning",
showCancelButton: true,
confirmButtonColor: "#d33",
confirmButtonText: "Logout"
}).then((result) => {
if (result.isConfirmed) {
localStorage.removeItem("access_token");
window.location.replace("/");
}
});
}

async function createGroup(){

const { value: groupName } = await Swal.fire({
title: "Create Group",
input: "text",
inputLabel: "Enter group name",
showCancelButton: true
});

if(!groupName) return;

const res = await fetch(`${BASE}/chats/groups/create/`,{
method:"POST",
headers:{
"Content-Type":"application/json",
"Authorization":"Bearer "+token
},
body:JSON.stringify({ name: groupName })
});

if(res.status === 201){
Swal.fire("Success","Group created successfully","success");
loadChats();
}else{
Swal.fire("Error","Could not create group","error");
}
}

//////////////////////////////////////////////////
// SEARCH USERS (PRIVATE)
//////////////////////////////////////////////////

async function searchUsers(){
const query=document.getElementById("userSearch").value;
if(query.length<1){
document.getElementById("searchResults").innerHTML="";
return;
}

const res=await fetch(`${BASE}/accounts/users/?search=${query}`,{
headers:{"Authorization":"Bearer "+token}
});
const users=await res.json();

const container=document.getElementById("searchResults");
container.innerHTML="";

users.forEach(u=>{
container.innerHTML+=`
<div class="chat-item bg-light"
onclick="openPrivate('${u.id}','${u.username}')">
ðŸ”Ž ${u.username}
</div>`;
});
}

//////////////////////////////////////////////////
// LOAD CHATS (PRIVATE + GROUP)
//////////////////////////////////////////////////

async function loadChats(){

const list=document.getElementById("chatList");
list.innerHTML="<h6 class='p-3'>Recent Chats</h6>";

const res=await fetch(`${BASE}/chats/recent/`,{
headers:{"Authorization":"Bearer "+token}
});
const chats=await res.json();

chats.forEach(u=>{
list.innerHTML+=`
<div class="chat-item"
onclick="openPrivate('${u.id}','${u.username}')">
ðŸ‘¤ ${u.username}
</div>`;
});

const groupRes=await fetch(`${BASE}/chats/groups/my-groups/`,{
headers:{"Authorization":"Bearer "+token}
});
const groups=await groupRes.json();

list.innerHTML+="<h6 class='p-3'>Groups</h6>";

groups.forEach(g=>{
list.innerHTML+=`
<div class="chat-item"
onclick="openGroup('${g.id}','${g.name}',${g.is_admin})">
ðŸ‘¥ ${g.name}
</div>`;
});
}

//////////////////////////////////////////////////
// OPEN PRIVATE
//////////////////////////////////////////////////

function openPrivate(id,name){
currentChat=id;
currentType="private";
document.getElementById("chatHeader").innerHTML=name;
loadMessages();
}

//////////////////////////////////////////////////
// OPEN GROUP (WITH 3 DOT MENU)
//////////////////////////////////////////////////

function openGroup(id,name,isAdmin){
currentChat=id;
currentType="group";

document.getElementById("chatHeader").innerHTML=`
<div class="d-flex justify-content-between w-100 align-items-center">
<span>${name}</span>

<div class="dropdown">
<button class="btn btn-light btn-sm" data-bs-toggle="dropdown">
â‹®
</button>
<ul class="dropdown-menu dropdown-menu-end">
<li>
<a class="dropdown-item" href="#" onclick="openMembersModal(${isAdmin})">
View Members
</a>
</li>
</ul>
</div>
</div>
`;

loadMessages();
}

//////////////////////////////////////////////////
// MEMBERS MODAL
//////////////////////////////////////////////////

async function openMembersModal(isAdmin){

const modal=new bootstrap.Modal(document.getElementById("membersModal"));
modal.show();

const res=await fetch(`${BASE}/chats/groups/${currentChat}/members/`,{
headers:{"Authorization":"Bearer "+token}
});
const members=await res.json();

const container=document.getElementById("memberList");
container.innerHTML="";

members.forEach(m=>{
container.innerHTML+=`
<div class="d-flex justify-content-between align-items-center mb-2">
<span>${m.username} ${m.is_admin?"(Admin)":""}</span>
${isAdmin && !m.is_admin ?
`<button class="btn btn-sm btn-danger"
onclick="removeMember('${m.id}')">Remove</button>`
:""}
</div>`;
});

document.getElementById("adminSection").style.display=
isAdmin?"block":"none";
}

//////////////////////////////////////////////////
// REMOVE MEMBER
//////////////////////////////////////////////////

async function removeMember(userId){

await fetch(`${BASE}/chats/groups/remove/`,{
method:"POST",
headers:{
"Content-Type":"application/json",
"Authorization":"Bearer "+token
},
body:JSON.stringify({group_id:currentChat,user_id:userId})
});

openMembersModal(true);
}

//////////////////////////////////////////////////
// SEARCH USERS TO ADD
//////////////////////////////////////////////////

// async function searchGroupUsers(){
// const query=document.getElementById("groupSearch").value;

// if(query.length<1){
// document.getElementById("groupSearchResults").innerHTML="";
// return;
// }

// const res=await fetch(`${BASE}/accounts/users/?search=${query}`,{
// headers:{"Authorization":"Bearer "+token}
// });
// const users=await res.json();

// const container=document.getElementById("groupSearchResults");
// container.innerHTML="";

// users.forEach(u=>{
// container.innerHTML+=`
// <div class="d-flex justify-content-between mb-2">
// <span>${u.username}</span>
// <button class="btn btn-sm btn-success"
// onclick="addMember('${u.id}')">Add</button>
// </div>`;
// });
// }

async function searchGroupUsers(){

const query=document.getElementById("groupSearch").value;

if(query.length<1){
document.getElementById("groupSearchResults").innerHTML="";
return;
}

// 1ï¸âƒ£ Get searched users
const res=await fetch(`${BASE}/accounts/users/?search=${query}`,{
headers:{"Authorization":"Bearer "+token}
});
const users=await res.json();

// 2ï¸âƒ£ Get current group members
const memberRes=await fetch(`${BASE}/chats/groups/${currentChat}/members/`,{
headers:{"Authorization":"Bearer "+token}
});
const members=await memberRes.json();

const memberIds = members.map(m => m.id);

const container=document.getElementById("groupSearchResults");
container.innerHTML="";

users.forEach(u=>{

const alreadyMember = memberIds.includes(u.id);

container.innerHTML+=`
<div class="d-flex justify-content-between mb-2">
<span>${u.username}</span>
<button class="btn btn-sm ${alreadyMember ? 'btn-secondary' : 'btn-success'}"
${alreadyMember ? 'onclick="memberExists()"' : `onclick="addMember('${u.id}')"`}>
${alreadyMember ? 'Already Member' : 'Add'}
</button>
</div>`;
});

}
function memberExists(){
Swal.fire("Info","Member already exists in this group","info");
}
//////////////////////////////////////////////////
// ADD MEMBER
//////////////////////////////////////////////////

async function addMember(userId){

await fetch(`${BASE}/chats/groups/add-member/`,{
method:"POST",
headers:{
"Content-Type":"application/json",
"Authorization":"Bearer "+token
},
body:JSON.stringify({group_id:currentChat,user_id:userId})
});

searchGroupUsers();
openMembersModal(true);
}

//////////////////////////////////////////////////
// LOAD MESSAGES
//////////////////////////////////////////////////

async function loadMessages(){

let url=currentType==="private"
?`${BASE}/chats/history/?user_id=${currentChat}`
:`${BASE}/chats/groups/history/?group_id=${currentChat}`;

const res=await fetch(url,{headers:{"Authorization":"Bearer "+token}});
const messages=await res.json();

const body=document.getElementById("chatBody");
body.innerHTML="";

messages.forEach(msg=>{
const div=document.createElement("div");
div.className=msg.sender_id===myId?"msg-sent":"msg-received";
div.innerHTML=`<strong>${msg.sender}</strong><br>${msg.text}`;
body.appendChild(div);
});

body.scrollTop=body.scrollHeight;
}

//////////////////////////////////////////////////

loadChats();
</script>

</body>
</html>