<!DOCTYPE html>
<html>
<head>
    <title>Chat Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f4f6f9;
        }

        .login-card {
            border-radius: 10px;
            background-color: #f4f6f9;
            border: none;
            padding: 30px;
        }

        h3 {
            color: #1f2937;
            font-weight: 600;
        }

        .form-control {
            border: 1px solid #d1d5db;
        }

        .form-control:focus {
            border-color: #2563eb;
            box-shadow: none;
        }

        .btn-primary {
            background-color: #1d8e1d;
            border: none;
        }

        .btn-primary:hover {
            background-color: #166f16;
        }

        .btn-success {
            background-color: #0e49c6;
            border: none;
        }

        .btn-success:hover {
            background-color: #0c3da8;
        }

        #msg {
            font-size: 14px;
        }

        #otpDisplay {
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>

<body class="d-flex align-items-center vh-100">

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-4">
            <div class="card login-card">

                <h3 class="text-center mb-4">Messenger ðŸ’¬</h3>

                <input type="text" id="phone" class="form-control mb-3"
                       placeholder="Enter phone number">

                <button onclick="sendOTP()" class="btn btn-primary w-100 mb-3">
                    Send OTP
                </button>

                <input type="text" id="otp" class="form-control mb-3"
                       placeholder="Enter OTP">

                <button onclick="verifyOTP()" class="btn btn-success w-100">
                    Verify & Login
                </button>

                <!-- OTP DISPLAY AREA -->
                <div id="otpDisplay" class="text-center mt-3 text-primary"></div>

                <!-- MESSAGE AREA -->
                <div id="msg" class="text-center mt-2 text-danger"></div>

            </div>
        </div>
    </div>
</div>

<script>
const BASE = "http://127.0.0.1:8000/accounts";

// If already logged in, go to dashboard
if (localStorage.getItem("access_token")) {
    window.location.replace("/dashboard/");
}

// SEND OTP
async function sendOTP() {

    const phone = document.getElementById("phone").value;
    const msgDiv = document.getElementById("msg");
    const otpDiv = document.getElementById("otpDisplay");

    msgDiv.innerText = "";
    otpDiv.innerText = "";

    if (!phone) {
        msgDiv.innerText = "Please enter phone number";
        return;
    }

    try {
        const res = await fetch(`${BASE}/login/`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ phone })
        });

        const data = await res.json();
        console.log("Send OTP response:", data);

        if (res.ok) {
            msgDiv.className = "text-center mt-2 text-success";
            msgDiv.innerText = data.message || "OTP sent successfully";

            // âœ… Display OTP on screen (for testing)
            otpDiv.innerText = "Your OTP is: " + data.otp;

        } else {
            msgDiv.className = "text-center mt-2 text-danger";
            msgDiv.innerText = data.error || "Failed to send OTP";
        }

    } catch (error) {
        msgDiv.innerText = "Server error. Check backend.";
        console.error(error);
    }
}

// VERIFY OTP
async function verifyOTP() {

    const phone = document.getElementById("phone").value;
    const otp = document.getElementById("otp").value;
    const msgDiv = document.getElementById("msg");

    if (!phone || !otp) {
        msgDiv.innerText = "Phone and OTP are required";
        return;
    }

    try {
        const res = await fetch(`${BASE}/verify-otp/`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ phone, otp })
        });

        const data = await res.json();
        console.log("Verify OTP response:", data);

        if (res.ok && data.access_token) {

            localStorage.setItem("access_token", data.access_token);
            localStorage.setItem("refresh_token", data.refresh_token);

            window.location.replace("/dashboard/");

        } else {
            msgDiv.innerText =
                data.error || data.detail || "OTP verification failed";
        }

    } catch (error) {
        msgDiv.innerText = "Server error during verification";
        console.error(error);
    }
}
</script>

</body>
</html>
